<?xml version="1.0" encoding="UTF-8"?>
<!-- created by Jordi Huguet (AMC) -->
<Pipeline xmlns="http://nrg.wustl.edu/pipeline" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://nrg.wustl.edu/pipeline ..\schema\pipeline.xsd"  xmlns:fileUtils="http://www.xnat.org/java/org.nrg.imagingtools.utils.FileUtils">
    <name>qap_fmri_processing</name>
    <location>/xnat/pipeline/amc-catalog/QAP</location>
    <description>Compute Quality Assessment Package metrics on functional MRI scan data</description>
    <documentation>
       <authors>
           <author>
               <lastname>Jordi</lastname>
            <firstname>Huguet</firstname>
           </author>
       </authors>
        <version>0.4</version>
        <input-parameters>
            <parameter>
                <name>scanIDs</name>
                <values>
                    <schemalink>xnat:imageSessionData/scans/scan/ID</schemalink>
                </values>
                <description>List of scan IDs of all affected scans of the session</description>
            </parameter>
            <parameter>
                <name>sessionID</name>
                <values>
                    <schemalink>xnat:imageSessionData/ID</schemalink>
                </values>
                <description>The XNAT unique ID (Accession Number) of the session</description>
            </parameter>
            <parameter>
                <name>sessionName</name>
                <values>
                    <schemalink>xnat:imageSessionData/label</schemalink>
                </values>
                <description>The session label or name</description>
            </parameter>
            <parameter>
                <name>projectID</name>
                <values>
                    <schemalink>xnat:imageSessionData/project</schemalink>
                </values>
                <description>Project identifier</description>
            </parameter>
            <parameter>
                <name>subjectID</name>
                <values>
                    <schemalink>xnat:imageSessionData/subject_ID</schemalink>
                </values>
                <description>Subject identifier</description>
            </parameter>
            <parameter>
                <name>spatial_analysis</name>
                <values>
                    <csv>Y,N</csv>
                </values>
                    <description>Set this value to Y to compute spatial QA metrics of functional data. Set it to N otherwise</description>
            </parameter>
            <parameter>
                <name>temporal_analysis</name>
                <values>
                    <csv>Y,N</csv>
                </values>
                    <description>Set this value to Y to compute temporal QA metrics of functional data. Set it to N otherwise</description>
            </parameter>
            <parameter>
                <name>store_results</name>
                <values>
                    <csv>Y,N</csv>
                </values>
                    <description>Set this value to Y to store back output files generated by QAP. Set it to N otherwise</description>
            </parameter>
            <parameter>
                <name>notify</name>
                <values>
                    <csv>1</csv>
                </values>
                <description>Set the value to 1 if you want the pipeline to notify the user when complete. Set it to 0 otherwise</description>
            </parameter>
        </input-parameters>
    </documentation>
    <outputFileNamePrefix>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/',/Pipeline/name/text())^</outputFileNamePrefix>
    <loop id="series" xpath="^/Pipeline/parameters/parameter[name='scanIDs']/values/list^"/>
    <!-- Info:: Description of the Pipeline -->
    <parameters>
        <parameter>
            <name>workdir</name>
            <values>
                <unique>^concat(/Pipeline/parameters/parameter[name='builddir']/values/unique/text(),'/',/Pipeline/parameters/parameter[name='sessionName']/values/unique/text())^</unique>
            </values>
        </parameter>
        <parameter>
            <name>JSESSION</name>
            <values>
                <unique>^fileUtils:getJSESSION('DUMMY')^</unique>
            </values>
            <description>session token</description>
        </parameter>
        <parameter>
            <name>subjectLabel</name>
            <values>
                <unique>^fileUtils:GetColumn(/Pipeline/parameters/parameter[name='host']/values/unique/text(), /Pipeline/parameters/parameter[name='user']/values/unique/text(), /Pipeline/parameters/parameter[name='pwd']/values/unique/text(),concat('data/archive/experiments?ID=',/Pipeline/parameters/parameter[name='sessionID']/values/unique/text(),'&amp;columns=subject_label,subject_ID&amp;format=json'),'subject_label')^</unique>
            </values>
            <description>The subject label (Intermediate Schematron XSL File)</description>
        </parameter>
        <parameter>
            <name>scans_type</name>
            <values>
                <unique>func</unique>
            </values>
        </parameter>
    </parameters>
    <steps>
        <step id="1a" description="Create a folder for hosting the raw data" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^">
            <resource name="mkdir" location="commandlineTools" >
                <argument id="p"/>
                <argument id="dirname">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/RAW')^</value>
                </argument>
            </resource>
        </step>
        <step id="1b" description="Create a folder for placing the organized raw data (BIDS spec)" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^">
            <resource name="mkdir" location="commandlineTools" >
                <argument id="p"/>
                <argument id="dirname">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS')^</value>
                </argument>
            </resource>
        </step>
        <step id="1c" description="Create a qap package working folder" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^">
            <resource name="mkdir" location="commandlineTools" >
                <argument id="p"/>
                <argument id="dirname">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_work')^</value>
                </argument>
            </resource>
        </step>
        <step id="1d" description="Create a qap package output folder" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^">
            <resource name="mkdir" location="commandlineTools" >
                <argument id="p"/>
                <argument id="dirname">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out')^</value>
                </argument>
            </resource>
        </step>
        <step id="2" description="Get suitable fMRI data and place it into the raw folder" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/RAW')^" continueOnFailure="false">
            <resource name="get_mri_data" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="auth_token">
                    <value>^concat(/Pipeline/parameters/parameter[name='user']/values/unique/text(),':',/Pipeline/parameters/parameter[name='pwd']/values/unique/text())^</value>
                </argument>
                <argument id="hostname">
                    <value>^/Pipeline/parameters/parameter[name='host']/values/unique/text()^</value>
                </argument>
                <argument id="project">
                    <value>^/Pipeline/parameters/parameter[name='projectID']/values/unique/text()^</value>
                </argument>
                <argument id="subjectID">
                    <value>^/Pipeline/parameters/parameter[name='subjectID']/values/unique/text()^</value>
                </argument>
                <argument id="experimentID">
                    <value>^/Pipeline/parameters/parameter[name='sessionID']/values/unique/text()^</value>
                </argument>
                <argument id="scans_type">
                    <value>^/Pipeline/parameters/parameter[name='scans_type']/values/unique/text()^</value>
                </argument>
                <argument id="output_directory">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/RAW')^</value>
                </argument>
            </resource>
        </step>
        <step id="3" description="Organize XNAT-downloaded imaging data using BIDS specification" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/RAW')^" continueOnFailure="false">
            <resource name="organize_data" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="project">
                    <value>^/Pipeline/parameters/parameter[name='projectID']/values/unique/text()^</value>
                </argument>
                <argument id="subjectName">
                    <value>^/Pipeline/parameters/parameter[name='subjectLabel']/values/unique/text()^</value>
                </argument>
                <argument id="sessionName">
                    <value>^/Pipeline/parameters/parameter[name='sessionName']/values/unique/text()^</value>
                </argument>
                <argument id="scans_type">
                    <value>^/Pipeline/parameters/parameter[name='scans_type']/values/unique/text()^</value>
                </argument>
                <argument id="input_data_directory">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/RAW')^</value>
                </argument>
            </resource>
        </step>
        <step id="4" description="Generate a file list (YAML) of all affected scan datasets" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS')^" continueOnFailure="false">
            <resource name="qap_raw_data_sublist_generator" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="site_folder">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS/',/Pipeline/parameters/parameter[name='projectID']/values/unique/text())^</value>
                </argument>
                <argument id="outfile_path">
                    <value>^concat('scanlist_w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.yaml')^</value>
                </argument>
                <argument id="scans_type">
                    <value>^/Pipeline/parameters/parameter[name='scans_type']/values/unique/text()^</value>
                </argument>
            </resource>
        </step>
        <step id="5" description="Create a configuration file (YAML format)" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS')^" continueOnFailure="false">
            <resource name="qap_config_generator" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="output_dir">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out')^</value>
                </argument>
                <argument id="working_dir">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_work')^</value>
                </argument>
                <argument id="config_file_path">
                    <value>^concat('config_w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.yaml')^</value>
                </argument>
                <argument id="scans_type">
                    <value>^/Pipeline/parameters/parameter[name='scans_type']/values/unique/text()^</value>
                </argument>
            </resource>
        </step>
        <step id="6a" description="Compute QA spatial metrics on functional MRI scan data" precondition="^/Pipeline/parameters/parameter[name='spatial_analysis']/values/unique/text()='Y'^" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS')^" continueOnFailure="false">
            <resource name="qap_functional_spatial" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="scan_list_file">
                    <value>^concat('scanlist_w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.yaml')^</value>
                </argument>
                <argument id="reports_flag"/>
                <argument id="config_file">
                    <value>^concat('config_w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.yaml')^</value>
                </argument>
            </resource>
        </step>
        <step id="6b" description="Parse QAP spatial results and store them as an XNAT assessment" precondition="^/Pipeline/parameters/parameter[name='spatial_analysis']/values/unique/text()='Y'^" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out')^" continueOnFailure="false">
            <resource name="qap_output_ingestor" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="auth_token">
                    <value>^concat(/Pipeline/parameters/parameter[name='user']/values/unique/text(),':',/Pipeline/parameters/parameter[name='pwd']/values/unique/text())^</value>
                </argument>
                <argument id="hostname">
                    <value>^/Pipeline/parameters/parameter[name='host']/values/unique/text()^</value>
                </argument>
                <argument id="project">
                    <value>^/Pipeline/parameters/parameter[name='projectID']/values/unique/text()^</value>
                </argument>
                <argument id="results_csv_file">
                    <value>qap_functional_spatial.csv</value>
                </argument>
                <argument id="analysis_type">
                    <value>spatial</value>
                </argument>
                <argument id="scans_type">
                    <value>^/Pipeline/parameters/parameter[name='scans_type']/values/unique/text()^</value>
                </argument>
            </resource>
        </step>
        <step id="7a" description="Compute QA temporal metrics on functional MRI scan data" precondition="^/Pipeline/parameters/parameter[name='temporal_analysis']/values/unique/text()='Y'^" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS')^" continueOnFailure="false">
            <resource name="qap_functional_temporal" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="scan_list_file">
                    <value>^concat('scanlist_w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.yaml')^</value>
                </argument>
                <argument id="reports_flag"/>
                <argument id="config_file">
                    <value>^concat('config_w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.yaml')^</value>
                </argument>
            </resource>
        </step>
        <step id="7b" description="Parse QAP temporal results and store them as an XNAT assessment" precondition="^/Pipeline/parameters/parameter[name='temporal_analysis']/values/unique/text()='Y'^" workdirectory="^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out')^" continueOnFailure="false">
            <resource name="qap_output_ingestor" location="/xnat/pipeline/amc-catalog/QAP/resource">
                <argument id="auth_token">
                    <value>^concat(/Pipeline/parameters/parameter[name='user']/values/unique/text(),':',/Pipeline/parameters/parameter[name='pwd']/values/unique/text())^</value>
                </argument>
                <argument id="hostname">
                    <value>^/Pipeline/parameters/parameter[name='host']/values/unique/text()^</value>
                </argument>
                <argument id="project">
                    <value>^/Pipeline/parameters/parameter[name='projectID']/values/unique/text()^</value>
                </argument>
                <argument id="results_csv_file">
                    <value>qap_functional_temporal.csv</value>
                </argument>
                <argument id="analysis_type">
                    <value>temporal</value>
                </argument>
                <argument id="scans_type">
                    <value>^/Pipeline/parameters/parameter[name='scans_type']/values/unique/text()^</value>
                </argument>                
            </resource>
        </step>
        <step id="8" description="Zip the directory with the result files" precondition="^/Pipeline/parameters/parameter[name='store_results']/values/unique/text()='Y'^" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^" continueOnFailure="false">
            <resource name="zip" location="commandlineTools" >
                <argument id="recursive"/>
                <argument id="archive">
                    <value>'QAP_fMRI_output.zip'</value>
                </argument>
                <argument id="folder">
                    <value>QAP_fMRI_out</value>
                </argument>
            </resource>
        </step>
        <step id="9" description="Create a QAP resource collection for QAP-related derived data and upload it" precondition="^/Pipeline/parameters/parameter[name='store_results']/values/unique/text()='Y'^" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^" continueOnFailure="false">
            <resource name="XnatDataClient" location="xnat_tools">
                <argument id="sessionId">
                    <value>^/Pipeline/parameters/parameter[name='JSESSION']/values/unique/text()^</value>
                </argument>
                <argument id="method">
                    <value>PUT</value>
                </argument>
                <argument id="remote">
                    <value>^concat('"',/Pipeline/parameters/parameter[name='host']/values/unique/text(),'data/archive/projects/',/Pipeline/parameters/parameter[name='projectID']/values/unique/text(),'/subjects/',/Pipeline/parameters/parameter[name='subjectID']/values/unique/text(),'/experiments/',/Pipeline/parameters/parameter[name='sessionID']/values/unique/text(),'/resources/QAP_fMRI?format=ZIP&amp;content=MRI_QA'"')^</value>
                </argument>
            </resource>
            <resource name="XnatDataClient" location="xnat_tools">
                <argument id="sessionId">
                    <value>^/Pipeline/parameters/parameter[name='JSESSION']/values/unique/text()^</value>
                </argument>
                <argument id="method">
                    <value>PUT</value>
                </argument>
                <argument id="remote">
                    <value>^concat('"',/Pipeline/parameters/parameter[name='host']/values/unique/text(),'data/archive/projects/',/Pipeline/parameters/parameter[name='projectID']/values/unique/text(),'/subjects/',/Pipeline/parameters/parameter[name='subjectID']/values/unique/text(),'/experiments/',/Pipeline/parameters/parameter[name='sessionID']/values/unique/text(),'/resources/QAP_fMRI/files/w',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'_QAP_fMRI_output.zip?format=ZIP&amp;extract=true&amp;content=MRI_QA')^</value>
                </argument>
                <argument id="infile">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'QAP_fMRI_output.zip')^</value>
                </argument>
            </resource>
        </step>              
        <step id="10" description="Delete the intermediate data" workdirectory="^/Pipeline/parameters/parameter[name='workdir']/values/unique/text()^" continueOnFailure="true">
            <resource name="rm" location="commandlineTools">
                <argument id="f"/>
                <argument id="r"/>
                <argument id="file">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/RAW')^</value>
                </argument>
            </resource>
            <resource name="rm" location="commandlineTools">
                <argument id="f"/>
                <argument id="r"/>
                <argument id="file">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/BIDS')^</value>
                </argument>
            </resource>
            <resource name="rm" location="commandlineTools">
                <argument id="f"/>
                <argument id="r"/>
                <argument id="file">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_work')^</value>
                </argument>
            </resource>
            <resource name="rm" location="commandlineTools">
                <argument id="f"/>
                <argument id="r"/>
                <argument id="file">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out.zip')^</value>
                </argument>
            </resource>
        </step>
        <step id="11" description="Create a workflow resource collection for pipeline-related metadata and upload pipeline XML file(s)" continueOnFailure="true">
            <resource name="XnatDataClient" location="xnat_tools">
                <argument id="sessionId">
                    <value>^/Pipeline/parameters/parameter[name='JSESSION']/values/unique/text()^</value>
                </argument>
                <argument id="method">
                    <value>PUT</value>
                </argument>
                <argument id="remote">
                    <value>^concat('"',/Pipeline/parameters/parameter[name='host']/values/unique/text(),'data/experiments/',/Pipeline/parameters/parameter[name='sessionID']/values/unique/text(),'/resources/workflows?format=XML&amp;content=PIPELINE_DEFINITION"')^</value>
                </argument>
            </resource>
            <resource name="XnatDataClient" location="xnat_tools">
                <argument id="sessionId">
                    <value>^/Pipeline/parameters/parameter[name='JSESSION']/values/unique/text()^</value>
                </argument>
                <argument id="method">
                    <value>PUT</value>
                </argument>
                <argument id="remote">
                    <value>^concat('"',/Pipeline/parameters/parameter[name='host']/values/unique/text(),'data/experiments/',/Pipeline/parameters/parameter[name='sessionID']/values/unique/text(),'/resources/workflows/files/',/Pipeline/parameters/parameter[name='workflowid']/values/unique/text(),'.xml?format=XML&amp;inbody=true&amp;content=',/Pipeline/name/text(),'"')^</value>
                </argument>
                <argument id="infile">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/',/Pipeline/name/text(),'_',/Pipeline/name/text(),'.xml')^</value>
                </argument>
            </resource>
        </step>
        <step id="END-Notify-ALL" description="User notification" precondition="^/Pipeline/parameters/parameter[name='notify']/values/unique/text()=1^">
            <resource name="Notifier" location="notifications">
                <argument id="user">
                    <value>^/Pipeline/parameters/parameter[name='user']/values/unique/text()^</value>
                </argument>
                <argument id="password">
                    <value>^/Pipeline/parameters/parameter[name='pwd']/values/unique/text()^</value>
                </argument>
                <argument id="to">
                    <value>^/Pipeline/parameters/parameter[name='useremail']/values/unique/text()^</value>
                </argument>
                <argument id="from">
                    <value>^/Pipeline/parameters/parameter[name='adminemail']/values/unique/text()^</value>
                </argument>
                <argument id="subject">
                    <value>^concat('[',/Pipeline/parameters/parameter[name='xnatserver']/values/unique/text(), '] QA analysis successfully performed for ',/Pipeline/parameters/parameter[name='sessionName']/values/unique/text() )^</value>
                </argument>
                <argument id="host">
                    <value>^/Pipeline/parameters/parameter[name='mailhost']/values/unique/text()^</value>
                </argument>
                <argument id="body">
                    <value>^concat('Dear ',/Pipeline/parameters/parameter[name='userfullname']/values/unique/text(),',&lt;br&gt; &lt;p&gt;', ' Quality Control metrics (functional MRI) have been computed for session ', /Pipeline/parameters/parameter[name='sessionName']/values/unique/text(),'. Details of the session are available &lt;a href="',/Pipeline/parameters/parameter[name='host']/values/unique/text(),'/app/action/DisplayItemAction/search_element/xnat:mrSessionData/search_field/xnat:mrSessionData.ID/search_value/',/Pipeline/parameters/parameter[name='sessionID']/values/unique/text(),'"&gt;', ' here. &lt;/a&gt; &lt;/p&gt;&lt;br&gt;', ' &lt;/p&gt;&lt;br&gt;', '3TMRI-XNAT Team.')^</value>
                </argument>
                <argument id="attachment">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out/qap_functional_spatial_',/Pipeline/parameters/parameter[name='subjectLabel']/values/unique/text(),'.pdf')^</value>
                </argument>
                <argument id="attachment">
                    <value>^concat(/Pipeline/parameters/parameter[name='workdir']/values/unique/text(),'/QAP_fMRI_out/qap_functional_temporal_',/Pipeline/parameters/parameter[name='subjectLabel']/values/unique/text(),'.pdf')^</value>
                </argument>
            </resource>
        </step>
    </steps>
</Pipeline>
